<div class="workflow-testing-container">
  <!-- Header -->
  <header class="app-header">
    <div class="title-block">
      <img src="/assets/icons/tcs_multicolor.png" alt="TCS Logo" class="tcs-logo">
      <div class="title-content">
        <span class="title-text">Mortgage Workflow Builder</span>
        <span class="title-sub">Design, orchestrate, and launch automated workflows</span>
      </div>
    </div>
    <button class="theme-toggle" (click)="toggleTheme()" [attr.aria-label]="isDarkTheme ? 'Switch to light theme' : 'Switch to dark theme'">
      <span class="theme-icon">{{ isDarkTheme ? 'üåô' : '‚òÄÔ∏è' }}</span>
      <span>{{ isDarkTheme ? 'Dark' : 'Light' }}</span>
    </button>
  </header>

  <!-- Three-Panel Layout -->
  <div class="testing-layout">
    <!-- LEFT PANEL: Loan Selection -->
    <div class="panel left-panel">
      <div class="panel-title-wrapper">
        <button class="back-button-inline" (click)="goBack()" title="Back to Workflow Builder">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </button>
        <h2 class="panel-title">Test Configuration</h2>
      </div>

      <div class="left-panel-content">
        <!-- Workflow Info -->
        <div class="workflow-info-section" *ngIf="currentWorkflowName">
          <label class="form-label">Testing Workflow</label>
          <div class="workflow-display">
            <svg viewBox="0 0 24 24" fill="currentColor" class="workflow-icon">
              <path d="M6 3v2h12V3H6zm10 4H8v5.17L6 14.17V21c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-6.83L16 12.17V7zm-2 14h-4v-5h4v5zm2-7.83L14 15v-3h-4v3l-2-1.83V9h8v4.17z"/>
            </svg>
            <div class="workflow-details">
              <div class="workflow-name">{{ currentWorkflowName }}</div>
              <div class="workflow-meta" *ngIf="currentWorkflowCategory">
                {{ currentWorkflowCategory }} ‚Ä¢ {{ currentWorkflowRunType | titlecase }} Level
              </div>
            </div>
          </div>
        </div>

        <!-- Select Loan Dropdown -->
        <div class="form-section">
          <label class="form-label">Select Loan *</label>
          <div class="custom-select" [class.open]="showLoanDropdown">
            <div class="select-display" (click)="showLoanDropdown = !showLoanDropdown">
              <span *ngIf="selectedLoan" class="selected-text">
                {{ getSelectedLoanText() }}
              </span>
              <span *ngIf="!selectedLoan" class="placeholder">Choose a loan to test</span>
              <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            </div>
            <div class="dropdown-menu" *ngIf="showLoanDropdown">
              <!-- Search inside dropdown -->
              <div class="dropdown-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input
                  type="text"
                  [(ngModel)]="searchQuery"
                  (input)="onSearch()"
                  placeholder="Search loans..."
                  (click)="$event.stopPropagation()"
                />
              </div>
              <!-- Loan options -->
              <div class="dropdown-options">
                <div class="loan-group" *ngFor="let loan of filteredLoans">
                  <!-- Loan radio button (for loan level or parent for borrower level) -->
                  <label class="dropdown-option-radio loan-option" *ngIf="testType === 'loan'">
                    <input
                      type="radio"
                      name="loanSelection"
                      [value]="loan.id"
                      [(ngModel)]="selectedLoanId"
                      (change)="onLoanSelected()"
                      class="radio-input"
                    />
                    <span class="radio-content">
                      <span class="loan-number-text">{{ loan.loanNumber }}</span>
                    </span>
                  </label>

                  <!-- Borrower level: show loan number as header, then borrower radio buttons -->
                  <div *ngIf="testType === 'borrower'" class="borrower-group">
                    <div class="loan-header-text">{{ loan.loanNumber }}</div>
                    <label
                      class="dropdown-option-radio borrower-option"
                      *ngFor="let borrower of loan.borrowers"
                    >
                      <input
                        type="radio"
                        name="borrowerSelection"
                        [value]="loan.id + '-' + borrower.id"
                        [checked]="selectedLoanId === loan.id && selectedBorrowerId === borrower.id"
                        (change)="onBorrowerSelected(loan.id, borrower.id)"
                        class="radio-input"
                      />
                      <span class="radio-content">
                        <span class="borrower-id">{{ borrower.name }}</span>
                        <span *ngIf="!borrower.isCoApplicant" class="primary-badge">Primary</span>
                      </span>
                    </label>
                  </div>
                </div>

                <div *ngIf="filteredLoans.length === 0" class="dropdown-empty">
                  <p>No loans found matching your search.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Start Test Button -->
      <div class="left-panel-footer">
        <button
          class="btn-primary test-button"
          (click)="startExecution()"
          [disabled]="!canStartTest() || isExecuting || !currentWorkflowName"
        >
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
          {{ isExecuting ? 'Test Running...' : 'Start Test' }}
        </button>

        <!-- Move to Production Toggle -->
        <div class="production-toggle-container">
          <label class="toggle-label">
            <input
              type="checkbox"
              [(ngModel)]="moveToProduction"
              (change)="onProductionToggle()"
              class="toggle-checkbox"
            />
            <span class="toggle-slider"></span>
            <span class="toggle-text">Move to Production</span>
          </label>
        </div>
      </div>
    </div>

    <!-- CENTER PANEL: Execution Viewer -->
    <div class="panel center-panel">
      <div *ngIf="!currentExecution" class="empty-execution">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <h3>No Test Running</h3>
        <p>Select a workflow and loan from the left panel to start testing.</p>
      </div>

      <div *ngIf="currentExecution" class="execution-viewer">
        <!-- Execution Header -->
        <div class="execution-header">
          <div class="execution-info">
            <h3>{{ currentExecution.workflowName }}</h3>
            <span class="execution-id">{{ currentExecution.id }}</span>
          </div>
          <div class="execution-header-right">
            <span
              class="execution-status-badge"
              [ngClass]="{
                'status-running': currentExecution.status === 'running',
                'status-completed': currentExecution.status === 'completed',
                'status-failed': currentExecution.status === 'failed'
              }"
            >
              {{ currentExecution.status | titlecase }}
            </span>

            <!-- Execution accuracy controls -->
            <div *ngIf="currentExecution.status === 'completed'" class="execution-accuracy">
              <span class="accuracy-label">Mark Execution:</span>
              <button
                class="btn-small"
                [class.btn-success]="currentExecution.executionAccuracy === 'correct'"
                (click)="markExecutionAccuracy('correct')"
              >
                ‚úì Correct
              </button>
              <button
                class="btn-small"
                [class.btn-danger]="currentExecution.executionAccuracy === 'incorrect'"
                (click)="markExecutionAccuracy('incorrect')"
              >
                ‚úó Incorrect
              </button>
            </div>
          </div>
        </div>

        <!-- Step Progress -->
        <div class="steps-container">
          <div
            class="step-card"
            *ngFor="let step of currentExecution.steps"
            [class.expanded]="step.isExpanded"
            [ngClass]="getStepStatusClass(step.status)"
          >
            <div class="step-header" (click)="toggleStepExpansion(step.stepNumber)">
              <div class="step-left">
                <span class="step-icon">{{ getStepStatusIcon(step.status) }}</span>
                <span class="node-type-icon" [ngClass]="getNodeIconClass(step.node)" [innerHTML]="getNodeIcon(step.node)"></span>
                <div class="step-info">
                  <div class="step-title">
                    <span class="step-number">Step {{ step.stepNumber }}</span>
                    <span class="step-name">{{ step.stepName }}</span>
                  </div>
                  <div class="step-meta">
                    <span class="step-node">{{ step.node }}</span>
                    <span *ngIf="step.duration" class="step-duration">{{ step.duration.toFixed(2) }}s</span>
                  </div>
                </div>
              </div>
              <div class="step-right">
                <span *ngIf="step.status === 'completed'" class="step-tokens">
                  {{ step.tokens.input + step.tokens.output }} tokens
                </span>
                <svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 10l5 5 5-5z"/>
                </svg>
              </div>
            </div>

            <!-- Expanded Content -->
            <div class="step-content" *ngIf="step.isExpanded && step.status !== 'pending'">
              <div class="step-section">
                <div class="section-header-with-icon">
                  <h4>Input Data</h4>
                  <button
                    *ngIf="isDocumentExtractionStep(step.node)"
                    class="view-doc-icon-btn"
                    (click)="openDocumentViewer(); $event.stopPropagation()"
                    title="View Document"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </button>
                </div>
                <pre class="json-viewer">{{ step.inputData | json }}</pre>
              </div>
              <div class="step-section" *ngIf="step.outputData">
                <h4>Output Data</h4>
                <pre class="json-viewer">{{ step.outputData | json }}</pre>
              </div>
              <div class="step-actions" *ngIf="step.status === 'completed'">
                <button class="btn-small btn-outline" (click)="openEditModal(step.stepNumber)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                  Edit Output
                </button>
                <button class="btn-small btn-primary" (click)="rerunFromStep(step.stepNumber)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 4v6h6M23 20v-6h-6"/>
                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                  </svg>
                  Rerun from Here
                </button>
              </div>

              <!-- Accuracy controls -->
              <div class="accuracy-controls" *ngIf="step.status === 'completed'">
                <button
                  class="btn-small"
                  [class.btn-success]="step.accuracyStatus === 'correct'"
                  (click)="markStepAccuracy(step.stepNumber, 'correct')"
                >
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                  Correct
                </button>
                <button
                  class="btn-small"
                  [class.btn-danger]="step.accuracyStatus === 'incorrect'"
                  (click)="markStepAccuracy(step.stepNumber, 'incorrect')"
                >
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                  Incorrect
                </button>
              </div>

              <!-- Show accuracy badge if verified -->
              <div *ngIf="step.accuracyStatus" class="accuracy-badge"
                   [ngClass]="{'badge-correct': step.accuracyStatus === 'correct', 'badge-incorrect': step.accuracyStatus === 'incorrect'}">
                {{ step.accuracyStatus === 'correct' ? '‚úì Verified Correct' : '‚úó Verified Incorrect' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Console Logs -->
        <div class="console-section">
          <h4 class="console-title">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 3H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h3v3c0 .55.45 1 1 1h8c.55 0 1-.45 1-1v-3h3c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm-5 12H9c-.55 0-1-.45-1-1s.45-1 1-1h6c.55 0 1 .45 1 1s-.45 1-1 1z"/>
            </svg>
            Console Logs
          </h4>
          <div class="console-logs">
            <div class="log-entry" *ngFor="let log of currentExecution.consoleLogs">
              {{ log }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL: Analytics -->
    <div class="panel right-panel">
      <div class="analytics-container">
        <!-- Accuracy Metrics Card -->
        <div class="analytics-card accuracy-card">
          <h3 class="analytics-title">
            <svg viewBox="0 0 24 24" fill="currentColor" class="title-icon">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            Accuracy Metrics
          </h3>

          <!-- Overall accuracy gauge -->
          <div class="accuracy-gauge">
            <div class="gauge-circle">
              <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" class="gauge-bg"/>
                <circle
                  cx="50" cy="50" r="45"
                  class="gauge-progress"
                  [style.stroke-dashoffset]="getGaugeOffset(accuracyMetrics.accuracyRate)"
                />
              </svg>
              <div class="gauge-value">{{ accuracyMetrics.accuracyRate.toFixed(1) }}%</div>
            </div>
            <div class="gauge-label">Overall Accuracy</div>
          </div>

          <!-- Accuracy stats grid -->
          <div class="accuracy-stats">
            <div class="stat-item stat-correct">
              <div class="stat-icon">‚úì</div>
              <div class="stat-label">Correct</div>
              <div class="stat-value">{{ accuracyMetrics.correctRuns }}</div>
            </div>
            <div class="stat-item stat-incorrect">
              <div class="stat-icon">‚úó</div>
              <div class="stat-label">Incorrect</div>
              <div class="stat-value">{{ accuracyMetrics.incorrectRuns }}</div>
            </div>
            <div class="stat-item stat-total">
              <div class="stat-icon">#</div>
              <div class="stat-label">Runs</div>
              <div class="stat-value">{{ accuracyMetrics.totalRuns }}</div>
            </div>
          </div>

          <!-- Test Coverage Section -->
          <div class="test-coverage-section">
            <h4>Test Coverage</h4>
            <div class="coverage-grid">
              <div class="coverage-item">
                <div class="coverage-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <div class="coverage-info">
                  <div class="coverage-value">{{ accuracyMetrics.uniqueLoans }}</div>
                  <div class="coverage-label">Unique Loans</div>
                </div>
              </div>
              <div class="coverage-item">
                <div class="coverage-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                </div>
                <div class="coverage-info">
                  <div class="coverage-value">{{ accuracyMetrics.uniqueBorrowers }}</div>
                  <div class="coverage-label">Unique Borrowers</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step-level accuracy table -->
          <div class="step-accuracy-summary">
            <h4>Step-Level Accuracy</h4>
            <div class="step-accuracy-table-container">
              <table class="step-accuracy-table">
                <thead>
                  <tr>
                    <th>Step</th>
                    <th>Correct</th>
                    <th>Incorrect</th>
                    <th>Total</th>
                    <th>Rate</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let step of accuracyMetrics.stepBreakdown">
                    <td class="step-name-cell">
                      <span class="step-number-badge">{{ step.stepNumber }}</span>
                      <span class="step-name-text">{{ step.stepName }}</span>
                    </td>
                    <td class="correct-cell">{{ step.correctCount }}</td>
                    <td class="incorrect-cell">{{ step.incorrectCount }}</td>
                    <td class="total-cell">{{ step.totalRuns }}</td>
                    <td class="rate-cell">
                      <span class="rate-badge" [ngClass]="{'rate-high': step.accuracyRate >= 90, 'rate-medium': step.accuracyRate >= 70 && step.accuracyRate < 90, 'rate-low': step.accuracyRate < 70}">
                        {{ step.accuracyRate.toFixed(1) }}%
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div *ngIf="accuracyMetrics.stepBreakdown.length === 0" class="no-data-message">
                No step accuracy data available yet. Mark steps as correct/incorrect to see statistics.
              </div>
            </div>
          </div>
        </div>

        <!-- Current Run Analytics Card -->
        <div class="analytics-card" *ngIf="currentExecution">
          <h3 class="analytics-title">
            <svg viewBox="0 0 24 24" fill="currentColor" class="title-icon">
              <path d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l2.6 1.53c.56-1.24.88-2.62.88-4.07 0-5.18-3.95-9.45-9-9.95zM12 19c-3.87 0-7-3.13-7-7 0-3.53 2.61-6.43 6-6.92V2.05c-5.06.5-9 4.76-9 9.95 0 5.52 4.47 10 9.99 10 3.31 0 6.24-1.61 8.06-4.09l-2.6-1.53C16.17 17.98 14.21 19 12 19z"/>
            </svg>
            Current Run
          </h3>
          <div class="analytics-grid">
            <div class="metric-item">
              <div class="metric-label">Input Tokens</div>
              <div class="metric-value">{{ currentExecution.analytics.totalInputTokens | number }}</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Output Tokens</div>
              <div class="metric-value">{{ currentExecution.analytics.totalOutputTokens | number }}</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Total Cost</div>
              <div class="metric-value cost">${{ currentExecution.analytics.totalCost.toFixed(4) }}</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Duration</div>
              <div class="metric-value">{{ currentExecution.analytics.totalDuration.toFixed(2) }}s</div>
            </div>
          </div>
        </div>

        <!-- Historical Averages Card -->
        <div class="analytics-card averages-card">
          <h3 class="analytics-title">
            <svg viewBox="0 0 24 24" fill="currentColor" class="title-icon">
              <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
            </svg>
            Historical Averages
            <span class="runs-count">({{ performanceAverages.totalRuns }} runs)</span>
          </h3>
          <div class="analytics-grid">
            <div class="metric-item">
              <div class="metric-label">Avg Input Tokens</div>
              <div class="metric-value">{{ performanceAverages.avgInputTokens | number: '1.0-0' }}</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Avg Output Tokens</div>
              <div class="metric-value">{{ performanceAverages.avgOutputTokens | number: '1.0-0' }}</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Avg Cost</div>
              <div class="metric-value cost">${{ performanceAverages.avgCost.toFixed(4) }}</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Avg Duration</div>
              <div class="metric-value">{{ performanceAverages.avgDuration.toFixed(2) }}s</div>
            </div>
          </div>
        </div>

        <!-- Step Breakdown -->
        <div class="analytics-card" *ngIf="currentExecution && currentExecution.analytics.stepBreakdown.length > 0">
          <h3 class="analytics-title">Step Breakdown</h3>
          <div class="breakdown-list">
            <div class="breakdown-item" *ngFor="let breakdown of currentExecution.analytics.stepBreakdown">
              <div class="breakdown-header">
                <span class="breakdown-step">Step {{ breakdown.stepNumber }}: {{ breakdown.stepName }}</span>
                <span class="breakdown-cost">${{ breakdown.cost.toFixed(4) }}</span>
              </div>
              <div class="breakdown-details">
                <span class="breakdown-detail">In: {{ breakdown.inputTokens }} | Out: {{ breakdown.outputTokens }}</span>
                <span class="breakdown-detail">{{ breakdown.duration.toFixed(2) }}s</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Test Info -->
        <div class="analytics-card test-info" *ngIf="currentExecution">
          <h3 class="analytics-title">Test Information</h3>
          <div class="info-item">
            <span class="info-label">Test Type:</span>
            <span class="info-value">{{ currentExecution.testType | titlecase }} Level</span>
          </div>
          <div class="info-item">
            <span class="info-label">Loan:</span>
            <span class="info-value">{{ getSelectedLoan()?.loanNumber }}</span>
          </div>
          <div class="info-item" *ngIf="currentExecution.borrowerId">
            <span class="info-label">Borrower:</span>
            <span class="info-value">{{ getSelectedBorrower()?.name }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Started:</span>
            <span class="info-value">{{ currentExecution.startTime | date:'short' }}</span>
          </div>
          <div class="info-item" *ngIf="currentExecution.endTime">
            <span class="info-label">Completed:</span>
            <span class="info-value">{{ currentExecution.endTime | date:'short' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="footer-content">
      <img src="/assets/icons/Tata_Consultancy_Services.png" alt="TCS Logo" class="footer-logo">
      <div class="footer-text">
        <span class="copyright">¬©2026 TATA Consultancy Services Limited</span>
        <a href="#" class="privacy-link">Privacy Notice</a>
      </div>
    </div>
  </footer>
</div>

<!-- Edit Output Modal -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Step {{ editingStepNumber }} Output</h3>
      <button class="close-button" (click)="closeEditModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <label class="form-label">Output JSON</label>
      <textarea
        class="json-editor"
        [(ngModel)]="editedOutput"
        rows="20"
        spellcheck="false"
      ></textarea>
      <p class="help-text">Edit the JSON output and click Save. Make sure the JSON is valid.</p>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeEditModal()">Cancel</button>
      <button class="btn-primary" (click)="saveEditedOutput()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal-overlay" *ngIf="showDocumentViewer" (click)="closeDocumentViewer()">
  <div class="document-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="document-header">
      <h3>{{ testType === 'loan' ? 'Loan' : 'Borrower' }} Documents</h3>
      <button class="close-button" (click)="closeDocumentViewer()">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <!-- Document Viewer Body -->
    <div class="document-body">
      <!-- Document List Sidebar -->
      <div class="document-sidebar">
        <div class="document-list">
          <div
            class="document-item"
            *ngFor="let doc of getDocumentsByLevel()"
            [class.active]="selectedDocument?.id === doc.id"
            (click)="selectDocument(doc)"
          >
            <div class="doc-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                <path d="M14 2v6h6"/>
              </svg>
            </div>
            <div class="doc-info">
              <div class="doc-name">{{ doc.name }}</div>
              <div class="doc-meta">
                <span class="doc-type">{{ doc.type | uppercase }}</span>
                <span class="doc-pages">{{ doc.pageCount }} pages</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PDF Viewer Area -->
      <div class="document-viewer-area">
        <div class="viewer-toolbar">
          <button class="toolbar-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Previous
          </button>
          <span class="page-indicator">Page 1 of {{ selectedDocument?.pageCount }}</span>
          <button class="toolbar-btn">
            Next
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
          <button class="toolbar-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m4-5l5 5 5-5m-5 5V3"/>
            </svg>
            Download
          </button>
        </div>

        <!-- Embedded PDF Viewer (using iframe with SafePipe) -->
        <div class="pdf-container">
          <iframe
            *ngIf="selectedDocument"
            [src]="selectedDocument.url | safe: 'resourceUrl'"
            class="pdf-iframe"
            frameborder="0"
          ></iframe>

          <!-- Fallback message -->
          <div *ngIf="!selectedDocument" class="no-document-selected">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p>Select a document to view</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
